<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bản đồ hiển thị địa chỉ mới nhất từ tọa độ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0;}
    h2 {
      font-size: 1.1em;
      font-weight: 500;
      line-height:1.35;
      padding: 12px 10px 0 10px;
      margin: 0;
      text-align: left;
    }
    .highlight { color: #e67e22; font-weight:bold; }
    #inputLocation {
      width: 100%;
      max-width: 340px;
      font-size: 1em;
      padding: 7px 8px;
      margin:10px 0 8px 0;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #bbb;
      display: block;
    }
    button {
      padding: 7px 12px;
      font-size: 1em;
      border-radius: 7px;
      border: none;
      background: #f3f3f3;
      color: #0076d7;
      margin-bottom:6px;
      margin-right: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    #map {
      height: 340px;
      margin:6px;
      border-radius: 10px;
      overflow:hidden;
    }
    .info-panel {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.09);
      padding: 12px 10px;
      margin: 6px;
      position: relative;
      min-width: 180px;
      max-width:95vw;
      max-height:160px;
      overflow: auto;
      font-size: 1em;
      word-break: break-word;
    }
    .info-panel button {margin:8px 0 0 0; width:100%; font-size:0.95em;}
    .footer {
      text-align: center;
      margin: 18px auto 14px auto;
      font-size: 15px;
      color: #888;
      font-weight: 400;
    }

    @media (max-width:600px) {
      h2 { font-size: 1em; padding:10px; }
      .info-panel{ font-size: 0.97em; padding:9px 8px; min-width:120px;}
      #inputLocation { font-size: 0.99em; max-width:100vw; }
      button { font-size: 0.99em; padding: 7px 10px; }
      #map { height: 220px; margin:4px; }
      .footer { font-size: 13px; margin: 12px 0 10px 0;}
    }
  </style>
</head>
<body>
  <h2>
    Nhập Tọa độ thập phân (DD) hoặc phút giây (DMS)<br>
    VD: 
    <span class="highlight">10.771716, 106.706078</span> hoặc 
    <span class="highlight">10°46'18.3"N 106°42'21.9"E</span> để xem địa chỉ mới
  </h2>
  <div style="padding:0 10px;">
    <input type="text" id="inputLocation" placeholder="Nhập tọa độ thập phân hoặc phút giây...">
    <button onclick="handleSearch()">Tìm kiếm</button>
    <div id="infoPanel" class="info-panel" style="display:none"></div>
  </div>
  <div id="map"></div>
  <div class="footer">
    Created by Minh Nhựt<br>
    © 2025
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([10.7769, 106.7009], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: "©OpenStreetMap" }).addTo(map);
    let marker = null;

    async function handleSearch() {
      const inputRaw = document.getElementById('inputLocation').value.trim();
      const input = inputRaw.replace(/[()]/g, '').replace(/\s+/g, ' ').replace(/,/g, ',').replace(/^\s+|\s+$/g, '');

      let latlng = parseLatLng(input);
      if (!latlng) {
        showInfo("Không nhận diện được tọa độ. Vui lòng nhập lại theo hướng dẫn!");
        return;
      }
      showMarker(latlng);
      map.setView([latlng.lat, latlng.lng], 16);
      showInfo("Đang tìm địa chỉ...");
      const address = await fetchAddress(latlng.lat, latlng.lng);
      showInfo(`<b>Địa chỉ mới nhất:</b><br><span id="addressText">${address}</span>
        <br><button onclick="copyAddress()">Sao chép địa chỉ</button>`);
    }

    function parseLatLng(str) {
      // Xử lý số thập phân
      let reDecimal = /^\s*([\-+]?\d+(?:\.\d+)?)\s*,\s*([\-+]?\d+(?:\.\d+)?)\s*$/i;
      let m = str.match(reDecimal);
      if (m) return {lat: parseFloat(m[1]), lng: parseFloat(m[2])};

      // Tọa độ độ phút giây
      let reDMS = /(\d+)[°:\s](\d+)[\':\s](\d+(\.\d+)?)[\"\s]?([NS])?\s*[ ,]?\s*(\d+)[°:\s](\d+)[\':\s](\d+(\.\d+)?)[\"\s]?([EW])?/i;
      m = str.match(reDMS);
      if (m) {
        let lat = dms2dec(+m[1], +m[2], +m[3], m[5]||'N');
        let lng = dms2dec(+m[6], +m[7], +m[8], m[10]||'E');
        return {lat, lng};
      }
      return null;
    }
    function dms2dec(d, m, s, dir) {
      let dec = d + m/60 + s/3600;
      if(dir=='S' || dir=='W') dec = -dec;
      return dec;
    }
    function showMarker({lat, lng}) {
      if(marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
    }
    async function fetchAddress(lat,lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=vi`;
        let r = await fetch(url);
        let j = await r.json();
        return j.display_name || "Không tìm thấy địa chỉ mới";
      } catch(e){ return "Lỗi khi truy vấn địa chỉ"; }
    }
    function showInfo(html) {
      let panel = document.getElementById('infoPanel');
      panel.innerHTML = html;
      panel.style.display = 'block';
    }
    function copyAddress() {
      let text = document.getElementById('addressText').innerText;
      navigator.clipboard.writeText(text);
      alert("Đã sao chép địa chỉ!");
    }
  </script>
</body>
</html>
