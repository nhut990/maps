<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bản đồ hiển thị địa chỉ mới nhất từ tọa độ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0;}
    h2 {
      font-size: 1.1em;
      font-weight: 500;
      line-height:1.35;
      padding: 12px 10px 0 10px;
      margin: 0;
      text-align: left;
    }
    .highlight { color: #e67e22; font-weight:bold; }
    #inputLocation {
      width: 100%;
      max-width: 340px;
      font-size: 1em;
      padding: 7px 8px;
      margin:10px 0 8px 0;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #bbb;
      display: block;
    }
    button {
      padding: 7px 12px;
      font-size: 1em;
      border-radius: 7px;
      border: none;
      background: #2693e0;
      color: #fff;
      margin-bottom:6px;
      margin-right: 4px;
      box-shadow: 0 1.5px 8px rgba(38,147,224,0.13);
      transition: background 0.2s, box-shadow 0.2s;
      font-weight: 500;
      letter-spacing: 0.02em;
      cursor: pointer;
    }
    button:hover {
      background: #176bb3;
      box-shadow: 0 2.5px 16px rgba(38,147,224,0.21);
    }
    #map-container {
      position: relative;
    }
    #map {
      height: 340px;
      margin:6px;
      border-radius: 10px;
      overflow:hidden;
    }
    /* Nút chuyển chế độ bản đồ */
    .map-layer-btn {
      position: absolute;
      top: 14px;
      right: 20px;
      background: #fff;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      box-shadow: 0 2.5px 8px rgba(0,0,0,0.20);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1002;
      border: 2.5px solid #2693e0;
      outline: none;
      padding: 0;
      transition: box-shadow 0.2s, border-color 0.15s, background 0.18s;
    }
    .map-layer-btn:hover {
      box-shadow: 0 6px 20px rgba(38,147,224,0.20);
      background: #e5f2fa;
      border-color: #176bb3;
    }
    .icon-layers {
      width: 27px;
      height: 27px;
      display: block;
    }
    /* Menu popup chọn layer đẹp */
    .layer-menu {
      display: none;
      position: absolute;
      top: 65px;
      right: 9px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 5px 22px rgba(38,147,224,0.12), 0 1.5px 6px rgba(0,0,0,0.08);
      z-index: 1003;
      min-width: 135px;
      font-size: 1em;
      font-weight: 500;
      overflow: visible;
      border: 1.5px solid #d3eafd;
      animation: popupIn 0.23s cubic-bezier(.51,1.24,.53,.93);
    }
    @keyframes popupIn {
      0% {opacity: 0; transform: translateY(-18px) scale(0.88);}
      100% {opacity: 1; transform: none;}
    }
    .layer-menu.active { display: block; }
    .layer-menu-item {
      display: block;
      padding: 12px 24px 12px 18px;
      cursor: pointer;
      border:none; outline: none;
      background: none;
      width: 100%;
      text-align: left;
      color: #2693e0;
      font-size: 1.06em;
      border-radius: 10px;
      transition: background 0.17s, color 0.15s;
      margin: 2px 0;
      font-weight: 500;
    }
    .layer-menu-item.selected, .layer-menu-item:hover {
      background: #2693e0;
      color: #fff;
    }
    .info-panel {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.09);
      padding: 12px 10px;
      margin: 6px;
      position: relative;
      min-width: 180px;
      max-width:95vw;
      max-height:160px;
      overflow: auto;
      font-size: 1em;
      word-break: break-word;
      opacity: 1;
      transition: opacity 0.8s;
    }
    .info-panel.fade-out {
      animation: fadeOut 0.8s forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to   { opacity: 0; }
    }
    .info-panel button {margin:8px 0 0 0; width:100%; font-size:0.95em;}
    .footer {
      text-align: center;
      margin: 18px auto 14px auto;
      font-size: 15px;
      color: #888;
      font-weight: 400;
    }
    @media (max-width:600px) {
      h2 { font-size: 1em; padding:10px; }
      .info-panel{ font-size: 0.97em; padding:9px 8px; min-width:120px;}
      #inputLocation { font-size: 0.99em; max-width:100vw; }
      button { font-size: 0.99em; padding: 7px 10px; }
      #map { height: 220px; margin:4px; }
      #map-container{ min-height:220px;}
      .footer { font-size: 13px; margin: 12px 0 10px 0;}
      .map-layer-btn { width:40px; height:40px; }
      .icon-layers {width:21px; height:21px;}
      .layer-menu { min-width:105px; }
      .layer-menu-item { padding-left: 14px; padding-right: 14px;}
    }
  </style>
</head>
<body>
  <h2>
    Nhập Tọa độ thập phân (DD) hoặc phút giây (DMS)<br>
    VD: 
    <span class="highlight">10.771716, 106.706078</span> hoặc 
    <span class="highlight">10°46'18.3"N 106°42'21.9"E</span> để xem địa chỉ mới
  </h2>
  <div style="padding:0 10px;">
    <input type="text" id="inputLocation" placeholder="Nhập tọa độ thập phân hoặc phút giây...">
    <button onclick="handleSearch()">Tìm kiếm</button>
    <div id="infoPanel" class="info-panel" style="display:none"></div>
  </div>
  <div id="map-container">
    <div id="map"></div>
    <!-- Nút chuyển layer: -->
    <button class="map-layer-btn" id="layerBtn" title="Chọn kiểu bản đồ" onclick="toggleLayerMenu(event)">
      <!-- Icon mới, dạng 2 lớp bản đồ, bo xanh/đen thanh lịch hơn -->
      <svg class="icon-layers" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="7" y="17" width="30" height="6" rx="2.3" fill="#1a5da9" stroke="#2693e0" stroke-width="1.5"/>
        <rect x="11" y="25" width="22" height="5" rx="1.9" fill="#2693e0" stroke="#1a5da9" stroke-width="1.1"/>
      </svg>
    </button>
    <!-- Layer menu popup -->
    <div class="layer-menu" id="layerMenu">
      <button class="layer-menu-item selected" onclick="setBaseLayer('default', this)">Mặc định</button>
      <button class="layer-menu-item" onclick="setBaseLayer('satellite', this)">Vệ tinh</button>
    </div>
  </div>
  <div class="footer">
    Created by Minh Nhựt<br>
    © 2025
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([10.7769, 106.7009], 10);

    // Tiles mặc định
    const defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:"©OpenStreetMap"});
    // Tiles vệ tinh (Esri)
    const satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: '© Esri' }
    );
    let currentLayer = defaultLayer.addTo(map);

    function setBaseLayer(type, btn) {
      if(type === 'default' && currentLayer !== defaultLayer) {
        map.removeLayer(currentLayer);
        currentLayer = defaultLayer.addTo(map);
      }
      if(type === 'satellite' && currentLayer !== satelliteLayer) {
        map.removeLayer(currentLayer);
        currentLayer = satelliteLayer.addTo(map);
      }
      // Đổi giao diện lựa chọn
      document.querySelectorAll('.layer-menu-item').forEach(e=>e.classList.remove('selected'));
      btn.classList.add('selected');
      hideLayerMenu();
    }

    // Nút popup menu
    function toggleLayerMenu(e) {
      let menu = document.getElementById('layerMenu');
      menu.classList.toggle('active');
      e.stopPropagation();
    }
    function hideLayerMenu() {
      document.getElementById('layerMenu').classList.remove('active');
    }
    document.addEventListener('click', function() { hideLayerMenu(); });

    let marker = null;

    async function handleSearch() {
      const inputRaw = document.getElementById('inputLocation').value.trim();
      const input = inputRaw.replace(/[()]/g, '').replace(/\s+/g, ' ').replace(/,/g, ',').replace(/^\s+|\s+$/g, '');

      let latlng = parseLatLng(input);
      if (!latlng) {
        showInfo("Không nhận diện được tọa độ. Vui lòng nhập lại theo hướng dẫn!");
        return;
      }
      showMarker(latlng);
      map.setView([latlng.lat, latlng.lng], 16);
      showInfo("Đang tìm địa chỉ...");
      const address = await fetchAddress(latlng.lat, latlng.lng);
      showInfo(`<b>Địa chỉ mới nhất:</b><br><span id="addressText">${address}</span>
        <br><button onclick="copyAddress()">Sao chép địa chỉ</button>`);
    }

    function parseLatLng(str) {
      // Xử lý số thập phân
      let reDecimal = /^\s*([\-+]?\d+(?:\.\d+)?)\s*,\s*([\-+]?\d+(?:\.\d+)?)\s*$/i;
      let m = str.match(reDecimal);
      if (m) return {lat: parseFloat(m[1]), lng: parseFloat(m[2])};

      // Tọa độ độ phút giây
      let reDMS = /(\d+)[°:\s](\d+)[\':\s](\d+(\.\d+)?)[\"\s]?([NS])?\s*[ ,]?\s*(\d+)[°:\s](\d+)[\':\s](\d+(\.\d+)?)[\"\s]?([EW])?/i;
      m = str.match(reDMS);
      if (m) {
        let lat = dms2dec(+m[1], +m[2], +m[3], m[5]||'N');
        let lng = dms2dec(+m[6], +m[7], +m[8], m[10]||'E');
        return {lat, lng};
      }
      return null;
    }
    function dms2dec(d, m, s, dir) {
      let dec = d + m/60 + s/3600;
      if(dir=='S' || dir=='W') dec = -dec;
      return dec;
    }
    function showMarker({lat, lng}) {
      if(marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
    }
    async function fetchAddress(lat,lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=vi`;
        let r = await fetch(url);
        let j = await r.json();
        return j.display_name || "Không tìm thấy địa chỉ mới";
      } catch(e){ return "Lỗi khi truy vấn địa chỉ"; }
    }
    function showInfo(html) {
      let panel = document.getElementById('infoPanel');
      panel.innerHTML = html;
      panel.style.display = 'block';
      panel.style.opacity = '1';
      panel.classList.remove('fade-out');
    }
    function copyAddress() {
      let text = document.getElementById('addressText').innerText;
      navigator.clipboard.writeText(text);
      alert("Đã sao chép địa chỉ!");
      // Hiệu ứng mờ dần và ẩn panel sau 3s
      const panel = document.getElementById('infoPanel');
      setTimeout(() => {
        panel.classList.add('fade-out');
        setTimeout(() => {
          panel.style.display = 'none';
          panel.classList.remove('fade-out');
        }, 800); // thời gian hiệu ứng mờ (khớp với css)
      }, 3000);
    }
  </script>
</body>
</html>